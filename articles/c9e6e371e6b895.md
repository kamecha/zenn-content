---
title: "psdのdiffをvimから見やすくしてみた"
emoji: "😎"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["denops", "vim", "neovim", "git"]
published: false
---

<!-- textlint-disable prh -->
書きたいこと
- gitのdiff確認はそれ用のツールを作る事ができる
    - 比較には同じ種類のファイルそれぞれがそのまま使われる
- psdファイルってなんかロマンあるよね
- vimdiffの恩恵に預かろう
- denopsを経由するとpdfのパーサライブラリ(ts制)を使えるぞい

時系列的には
1. psdの差分を簡単に見たい
1. gitのdiffを使ってpsdの差分を見る
1. gitのdiffはスナップショットの差分なので、それぞれのファイルの差分を見られればOK
1. vimdiffで差分を見られるので、そこの仕組みに乗っかれれば簡単
1. psdのパース手法として、npmのライブラリを使いたい
1. denopsを使ってvimからtsのライブラリを使う
<!-- textlint-enable prh -->

# はじめに
プログラミングとかをしていると、gitを使って差分が見られるのはとっても便利ですよね！？
そんな便利なgitですが、psdファイル等のバイナリっぽいファイル差分を見るにはちょっと難しいです。

自分は趣味でお絵描きをすることがあり、普段使っているgitのdiffのように差分管理できればいいなと思いました。
そうはいっても、通常のお絵描きソフトではgitの連携はおろか差分の確認すらできません。
最終的にはpsdの差分管理を内蔵したお絵描きソフトでも作ろうかなぁとか思っていますが、
まずは簡単に実現できる用にvimのプラグインとして作ってみました。

実用とは程遠いですが、psdファイルの差分をvimdiff形式で見ることができるようになります。

https://github.com/kamecha/psd_diff

これを作る過程で得た知見を紹介します。

## 使用例
何はともあれ、使用している様子を見てみましょう。
まずは上記のプラグインをvimプラグインとして、お好きな方法でインストールします。
このプラグインはdenops.vimに依存しているので、Deno・denops.vim両方をインストールしておいてください。
ここではインストールの方法は省略します。

そして、お絵描きソフトでそれぞれの状態を保存、gitにコミットします。

![git管理された事を表現するlog](https://storage.googleapis.com/zenn-user-upload/0365133b0255-20240526.png)

1. `はじまりのver`としてコミット
![初期の絵](https://storage.googleapis.com/zenn-user-upload/1639937db382-20240526.png =750x)

1. 編集を加えた後に、`ツヤとか諸々描き足したよ～`としてコミット
![編集を加えた絵](https://storage.googleapis.com/zenn-user-upload/79ee98b28430-20240526.png)

1. `git difftool --extcmd "nvim -c 'autocmd User DenopsPluginPost:psd_diff ++once PsdDiffArgs'" 89a2a8d 187347d
`を実行
![プラグイン導入後のdiff](https://storage.googleapis.com/zenn-user-upload/5a1b1fa3046e-20240526.png)

編集したpsdファイルの差分がvimdiff形式で表示されました。
バイナリファイルをそれぞれ目grepするよりは、かなり見やすくなったのではないでしょうか。

# psdファイル
お絵描きソフトで良く使われるpsdファイルですが、お絵描きしない人には馴染みが無いと思うので、ちょっとだけ説明します。
ありがたい事に、psdファイルの仕様はAdobeが公開しているので、それを参考にします。
いやぁ仕様が公開されてるのってありがたいですね～

https://www.adobe.com/devnet-apps/photoshop/fileformatashtml/

pngやjpegといった画像ファイルとは違い、レイヤーという概念が登場します。
透明な板に絵を描いて、それを重ね、上から見るように表示しているといった感じです。

今回差分表示を試みるのは、このレイヤー情報です。

# git
https://git-scm.com/
gitは版管理ツールです。
プログラミング等に利用される事が多いですが、お絵描きにも適用できないかなぁ
と個人的に考えています。
特に好きな機能としては以下のものがあります。
- commitがスナップショットである
- diffを取ることができる
- mergeができる

これらの機能を有効活用できるお絵描きソフトがあれば便利そうですよねぇ

今回はこのうちdiffに着目して、vim上で再現しようとています。

## `git difftool`
https://git-scm.com/docs/git-difftool
diffを取る際には`git diff`を使いますが、diff用のツールを指定する方法が`git difftool`です。
今回はこのコマンドを使ってvimを呼び出し、psdファイルの差分を見ることにします。

詳細はリンク先を見て欲しいのですが、`--extcmd`オプションを使うことで、外部コマンドを実行することができるので、これを利用します。

使用例で紹介したコマンドを分解すると以下のように解釈できます。
`git difftool --extcmd "nvim -c 'autocmd User DenopsPluginPost:psd_diff ++once PsdDiffArgs'" 89a2a8d 187347d`

- `git difftool --extcmd <command> 89a2a8d 187347d`
    - commandとしてnvimを使用し、`nvim $LOCAL $REMOTE`を実行する
    - `$LOCAL`・`$REMOTE`にはそれぞれ比較対象の(スナップショットから復元された)ファイルが渡される
- `nvim -c 'autocmd User DenopsPluginPost:psd_diff ++once PsdDiffArgs'`
    - nvimを起動し、`autocmd User DenopsPluginPost:psd_diff ++once PsdDiffArgs`を実行する
    - denops.vimがプラグインであるpsd_diffを読み込んだ後に、一度だけPsdDiffArgsコマンドを実行するautocmdを登録する

つまり作成するプラグインの機能としては、2つのpsdファイルを受取り、そのdiffを表示するコマンドを提供すれば良いことになります。

## vimdiff
https://vim-jp.org/vimdoc-ja/diff.html
そもそもvimにはdiff表示機能があります。

# denopsを用いたプラグイン開発
https://github.com/vim-denops/denops.vim

# おわりに
