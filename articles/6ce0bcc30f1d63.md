---
title: "dduのツリー対応ソースを作ろう"
emoji: "😽"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["vim", "neovim", "denops"]
published: false
---

# あらすじ
[ddu.vim](https://github.com/Shougo/ddu.vim)...良い～プラグインですよね～
かくいうわたくしもね、日々dduで理想の環境を構築すべく、sourceとかcolumnとかを自作して、もろもろの設定を頑張っている次第であります。
最近だとdduの設定をもろもろして、以下のような見た目にしてたりします。
![](https://storage.googleapis.com/zenn-user-upload/c2287fe0c122-20240201.png)

さてはて、色々やってると思う事があります
「あれ？...dduのソースでツリーに対応するためのweb記事...無くね！？」
と...
まぁ自分、ググリフォース力あまり無いので(検索して先頭数記事しかロクに見ない)、こんなの戯言で実際の†インターネット†の海の中にはツリー対応の記事が多々あるのかもしれませんが..

───そんなこんなでdduの自作ソースにツリー対応を入れようとした所、案外あっさりと実装できちゃったので、その知見を共有しようと思います。
これで広大な†インターネット†の中にdduのツリー対応のための記事がまた一つ増えるわけですねぇ
う～ん良い話だ

## 読むと嬉しくなる人
- dduの設定はある程度(ソースをちゃんと起動)できてる人
- dduのソースを自作したいと思っている人
- それとなくdduのお気持ちを知りたい人

# dduでのツリー表現
さて、実際にソースを実装する前にdduではどんな風にツリーを表現してるんだっけ？
っていうのをおさらいしていきますかね。
ちなみにdduのソースの実際の実装をサッて確認だけしたい！
って方はさっさとこの部分を飛ばして読んでいきましょう。(後で暇な時にこの部分も見てくれると嬉しい...かも...(／≧ω＼))

<!-- TODO:expandItemでの判定について書きたい -->

# 実際の実装
実際のソースの実装としては、既に作者様の記事があるので、そちらを参考にします。
https://zenn.dev/shougo/articles/ddu-vim-make-plugins#source-%E3%81%AE%E4%BD%9C%E6%88%90%E6%96%B9%E6%B3%95
参考記事である程度ソース作りの雰囲気を掴んだ上で、さらにツリー対応を入れちゃおう！ってすんぽうですな
先ほど記述している事ですが、dduは`expandItem`や`collapseItem`アクションでツリーを表現しています。
これらのアクションでツリーが機能するために必要なアイテムの属性があります。
それが、
- `isTree`(`:h ddu-item-attribute-isTree`)
- `treePath`(`:h ddu-item-attribute-treePath`)

この2つです。こいつらに何かしらの値が入ってれば、対応するアクションでソースの取得が走るようになります。

具体的な判定方法の本体実装はこんな感じになっているみたいです。
https://github.com/Shougo/ddu.vim/blob/a93187ca28702642b59d50efbd135efbf64cd58d/denops/ddu/ddu.ts#L1229-L1247

## 挙動
<!-- expandItemで呼ばれる度、gatherが走るから、parentとかで場合分けしてやると良い -->

# おわりに
